//mark.lawrence
//app.module.js

(function () {
    angular.module('app',
    [
        //application modules
        'app.core',
        'app.service',
        'app.filter',

        //feature areas
        'app.nav',
        'app.users',
        //'app.tax',
        //'app.template',
        //'app.mailers',
        //'app.events'
    ]);
})();
//core.module.js
//mark.lawrence

(function () {
    angular.module('app.core',
        [
            //angular modules
            'ngMessages',
            'angularLocalStorage',
            'ngRoute',
            'ngAnimate',

            //custom modules
            'blocks.logger',
            'blocks.exception',

            //third party modules
            'smart-table',
            'ui.bootstrap',
            'ngTagsInput',
            'ngFileUpload',
            'rzModule',
            'switcher',
            'gfl.textAvatar',
            'textAngular',
            'ui.bootstrap.datetimepicker', 
            'angular-confirm' 
        ])
        .constant('toastr', toastr)
        .constant('moment', moment);

})();
//config.js
//mark.lawrence
(function () {
    function toastrConfig(toastr) {
        toastr.options.timeOut = 4000;
        toastr.options.positionClass = 'toast-bottom-right';
    };

    var keyCodes = {
        backspace: 8,
        tab: 9,
        enter: 13,
        esc: 27,
        space: 32,
        pageup: 33,
        pagedown: 34,
        end: 35,
        home: 36,
        left: 37,
        up: 38,
        right: 39,
        down: 40,
        insert: 45,
        del: 46
    };

    var apiEndPoints = {
        User: 'users',
        Constituent: 'constituent',
        Tax: 'tax',
        Template: 'template',
        Campaign: 'campaign',
        Mailer: 'mailer',
        Reason: 'reason',
        Event: 'event',
        Guest: 'guest',
        File: 'file'
    };

    var config = {
        appErrorPrefix: '[DG Error] ', //Configure the exceptionHandler decorator
        appTitle: 'DonorGateway',
        version: '1.0.0',
        apiUrl: 'http://' + window.location.host + '/api/',
        keyCodes: keyCodes,
        apiEndPoints: apiEndPoints
    };

    var defaults = {
        EMAIL_SUFFIX: '@splcenter.org',
        GENERIC_PASSWORD: '1P@ssword'
    };

    angular.module('app.core')
        .config(toastrConfig)
        .constant('config', config)
        .value('defaults', defaults);
})();
//mark.lawrence
//exception.module.js

(function () {
    angular.module('blocks.exception', ['blocks.logger']);
})();
(function () {
    'use strict';

    angular.module('blocks.logger', []);
})();
//filter.module.js
//mark.lawrence

(function () {
    angular.module('app.filter', []);
})();
//mark.lawrence
//nav.module.js

(function () {
    angular.module('app.nav', []);
})();
//service.module.js
//mark.lawrence

(function () {
    angular.module('app.service', []);
})();
(function () {
    'use strict';

    angular.module('app.users', []);
})();
//mark.lawrence
//exception-handler.provider.js

// Include in index.html so that app level exceptions are handled.
// Exclude from testRunner.html which should run exactly what it wants to run
(function () {
    'use strict';

    angular
        .module('blocks.exception')
        .provider('exceptionHandler', exceptionHandlerProvider)
        .config(config);

    /**
     * Must configure the exception handling
     * @return {[type]}
     */
    function exceptionHandlerProvider() {
        /* jshint validthis:true */
        this.config = {
            appErrorPrefix: undefined
        };

        this.configure = function (appErrorPrefix) {
            this.config.appErrorPrefix = appErrorPrefix;
        };

        this.$get = function () {
            return { config: this.config };
        };
    };

    /**
     * Configure by setting an optional string value for appErrorPrefix.
     * Accessible via config.appErrorPrefix (via config value).
     * @param  {[type]} $provide
     * @return {[type]}
     * @ngInject
     */
    function config($provide) {
        $provide.decorator('$exceptionHandler', extendExceptionHandler);
    };

    /**
     * Extend the $exceptionHandler service to also display a toast.
     * @param  {Object} $delegate
     * @param  {Object} exceptionHandler
     * @param  {Object} logger
     * @return {Function} the decorated $exceptionHandler service
     */
    function extendExceptionHandler($delegate, exceptionHandler, logger) {
        return function (exception, cause) {
            var appErrorPrefix = exceptionHandler.config.appErrorPrefix || '';
            var errorData = { exception: exception, cause: cause };
            exception.message = appErrorPrefix + exception.message;
            $delegate(exception, cause);
            /**
             * Could add the error to a service's collection,
             * add errors to $rootScope, log errors to remote web server,
             * or log locally. Or throw hard. It is entirely up to you.
             * throw exception;
             *
             * @example
             *     throw { message: 'error message we added' };
             */
            logger.error(exception.message, errorData);
        };
    };
})();
//mark.lawrence
//exception.js

(function () {
    'use strict';

    angular
        .module('blocks.exception')
        .factory('exception', exception);

    /* @ngInject */
    function exception(logger) {
        var service = {
            catcher: catcher
        };

        return service;

        function catcher(message) {
            return function (reason) {
                logger.error(message, reason);
            };
        };
    };
})();
//mark.lawrence
//logger.js

(function () {
    'use strict';

    angular.module('blocks.logger').factory('logger', logger);

    logger.$inject = ['$log', 'toastr'];

    function logger($log, toastr) {
        var service = {
            showToasts: true,

            error: error,
            info: info,
            success: success,
            warning: warning,

            // straight to console; bypass toastr
            log: $log.log
        };

        return service;
        /////////////////////

        function error(message, data, title) {
            toastr.error(message, title);
            $log.error('Error: ' + message, data);
        };

        function info(message, data, title) {
            toastr.info(message, title);
            $log.info('Info: ' + message, data);
        };

        function success(message, data, title) {
            toastr.success(message, title);
            $log.info('Success: ' + message, data);
        };

        function warning(message, data, title) {
            toastr.warning(message, title);
            $log.warn('Warning: ' + message, data);
        };
    };
})();
//app.filter.js
//mark.lawrence

angular.module('app.filter').filter('percentage', ['$filter', function ($filter) {
    return function (input, decimals) {
        return $filter('number')(input * 100, decimals) + '%';
    };
}]);

angular.module('app.filter', []).filter('checkmark', function () {
    return function (input) {
        return input ? '\u2713' : '\u2718';
    };
});

angular.module('app.filter').filter('yesNo', function () {
    return function (input) {
        return input ? 'Yes' : 'No';
    }
});

angular.module('app.filter').filter('updateStatus', function () {
    return function (input) {
        if (input === 1) {
            return 'Unchanged';
        }
        if (input === 2) {
            return 'Changed';
        }
        if (input === 6) {
            return 'Reconciled';
        }
        return "";
    };
});
//mark.lawrence
//nav.js

(function () {
    'use strict';

    var controllerId = 'NavController';

    angular.module('app.nav').controller(controllerId, mainController);

    mainController.$inject = ['logger'];

    function mainController(logger) {
        var vm = this;

        activate();

        function activate() {
            logger.log(controllerId + ' activated');
            vm.user = JSON.parse(localStorage.getItem('currentUser'));
        }
    };
})();
//user.service.js
//mark.lawrence

(function () {
    'use strict';

    var serviceId = 'userService';
    angular.module('app.service').factory(serviceId, serviceController);

    function serviceController(logger, $http, config) {
        logger.log(serviceId + ' loaded');
        var url = config.apiUrl + config.apiEndPoints.User;

        var service = {
            availableRoles: availableRoles,
            create: create,
            get: get,
            query: query,
            remove: remove,
            update: update
        }

        return service;

        function availableRoles() {
            return $http.get(url + '/roles').then(_success);
        }

        function create(user) {
            return $http.post(url, user).then(_success, function (error) {
                logger.log('error', error);
            });
        }

        function get() {
            return $http.get(url).then(_success);
        }

        function query(searchTerm) {
            var searchUrl = url + '/search/';

            if (searchTerm != undefined && searchTerm.length > 0) {
                searchUrl += '?' + searchTerm;
            };
            return $http.get(searchUrl).then(_success);
        }

        function update(user) {
            return $http.put(url, user).then(_success);
        }

        function remove(id) {
            return $http.delete(url + '/' + id).then(_success);
        }

        function _success(response) {
            return response.data;
        }
    }
})();
(function () {
    'use strict'; 

    var controllerId = 'UserController';

    angular.module('app.users').controller(controllerId, UserController);

    UserController.$inject = ['logger', 'userService', 'defaults', 'config'];

    function UserController(logger, service, defaults, config) {
        var vm = this;
        vm.title = 'User Manager';
        vm.description = 'Edit and update users';
        var keyCodes = config.keyCodes;

        vm.availableRoles = [];
        vm.clearCreate = clearCreate;
        vm.currentEdit = {};
        vm.isBusy = false;
        vm.lastDeleted = null;
        vm.lastUpdated = null;
        vm.itemToEdit = {};

        vm.user = {
            //userName: null,
            roles: ['user'],
            fullName: '',
            password: defaults.GENERIC_PASSWORD
        };

        var tableStateRef;

        activate();

        function activate() {
            logger.log(controllerId + ' activated');
            getAvailableRoles();
        };

        vm.addItem = function () {
            vm.user.fullName = parseFullName(vm.user.userName);
            vm.user.email = vm.user.userName + defaults.EMAIL_SUFFIX;
            service.create(vm.user)
                .then(function (data) {
                    //TODO: mapping would allow removal of extend method
                    vm.user = angular.extend(vm.user, data);
                    vm.users.unshift(angular.copy(vm.user));
                    logger.success('User ' + vm.user.userName + ' created!');
                    vm.user.userName = null;
                    //TODO: show error user already exists
                });
        };

        vm.cancelEdit = function (id) {
            vm.currentEdit[id] = false;
        };

        vm.deleteItem = function (user) {
            angular.copy(user, vm.lastDeleted = {});
            service.remove(user.id)
                .then(function (data) {
                    var idx = vm.users.indexOf(user);
                    vm.users.splice(idx, 1);
                });
        };

        vm.editItem = function (user) {
            vm.currentEdit[user.id] = true;
            angular.copy(user, vm.itemToEdit = {});
        };

        function getAvailableRoles() {
            service.availableRoles()
                .then(function (data) {
                    vm.availableRoles = data;
                });
        };

        vm.saveItem = function (user) {
            vm.isBusy = true;

            vm.currentEdit[user.id] = false;
            angular.copy(user, vm.lastUpdated = {});
            var roles = [];

            _.forEach(vm.itemToEdit.roles,
                function (role) {
                    roles.push(role.name);
                });
            vm.itemToEdit.roles = roles;

            service.update(vm.itemToEdit)
                .then(function (data) {
                    angular.extend(user, data);
                    logger.success('User ' + data.userName + ' updated!');
                    vm.isBusy = false;
                });
        };

        vm.search = function (tableState) {
            tableStateRef = tableState;
            var searchTerm;

            if (typeof (tableState.search.predicateObject) != 'undefined') {
                searchTerm = tableState.search.predicateObject.searchTerm;
            }

            vm.isBusy = true;
            service.query(searchTerm)
                .then(function (data) {
                    vm.users = data;
                    logger.log('users', vm.users);
                })
                .finally(function () {
                    vm.isBusy = false;
                });
        };

        vm.undoDelete = function () {
            var roles = [];

            _.forEach(vm.lastDeleted.roles, function (role) {
                roles.push(role.name);
                logger.log('role', role.name);
            });
            vm.lastDeleted.roles = roles;
            vm.lastDeleted.password = defaults.GENERIC_PASSWORD;

            service.create(vm.lastDeleted).then(function (data) {
                logger.success('Successfully restored ' + data.userName);
                vm.users.unshift(data);
                vm.lastDeleted = null;
            });
        };

        vm.undoChange = function () {
            vm.isBusy = true;

            service.update(vm.lastUpdated)
                .then(function (data) {
                    angular.forEach(vm.users,
                        function (u, i) {
                            if (u.id === vm.lastUpdated.id) {
                                vm.users[i] = vm.lastUpdated;
                            }
                        });
                    logger.success('Successfully restored ' + data.userName);
                    vm.lastUpdated = null;
                })
                .finally(function () {
                    vm.isBusy = false;
                });
        };

        function clearCreate($event) {
            if ($event.keyCode === keyCodes.esc) {
                vm.user.userName = '';
            };
        };

        function parseFullName(name) {
            var arr = name.split('.');
            var fullname = '';

            _.forEach(arr, function (v) {
                fullname += _.capitalize(v) + ' ';
            });

            return _.trim(fullname);
        };
    };
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5tb2R1bGUuanMiLCJjb3JlL2NvcmUubW9kdWxlLmpzIiwiY29yZS9jb25maWcuanMiLCJibG9ja3MvZXhjZXB0aW9uL2V4Y2VwdGlvbi5tb2R1bGUuanMiLCJibG9ja3MvbG9nZ2VyL2xvZ2dlci5tb2R1bGUuanMiLCJmaWx0ZXJzL2ZpbHRlci5tb2R1bGUuanMiLCJuYXYvbmF2Lm1vZHVsZS5qcyIsInNlcnZpY2VzL3NlcnZpY2UubW9kdWxlLmpzIiwidXNlcnMvdXNlcnMubW9kdWxlLmpzIiwiYmxvY2tzL2V4Y2VwdGlvbi9leGNlcHRpb24taGFuZGxlci5wcm92aWRlci5qcyIsImJsb2Nrcy9leGNlcHRpb24vZXhjZXB0aW9uLmpzIiwiYmxvY2tzL2xvZ2dlci9sb2dnZXIuanMiLCJmaWx0ZXJzL2FwcC5maWx0ZXJzLmpzIiwibmF2L25hdi5qcyIsInNlcnZpY2VzL3VzZXIuc2VydmljZS5qcyIsInVzZXJzL3VzZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDSkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ0pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibW9kdWxlcy5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvL21hcmsubGF3cmVuY2VcclxuLy9hcHAubW9kdWxlLmpzXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgYW5ndWxhci5tb2R1bGUoJ2FwcCcsXHJcbiAgICBbXHJcbiAgICAgICAgLy9hcHBsaWNhdGlvbiBtb2R1bGVzXHJcbiAgICAgICAgJ2FwcC5jb3JlJyxcclxuICAgICAgICAnYXBwLnNlcnZpY2UnLFxyXG4gICAgICAgICdhcHAuZmlsdGVyJyxcclxuXHJcbiAgICAgICAgLy9mZWF0dXJlIGFyZWFzXHJcbiAgICAgICAgJ2FwcC5uYXYnLFxyXG4gICAgICAgICdhcHAudXNlcnMnLFxyXG4gICAgICAgIC8vJ2FwcC50YXgnLFxyXG4gICAgICAgIC8vJ2FwcC50ZW1wbGF0ZScsXHJcbiAgICAgICAgLy8nYXBwLm1haWxlcnMnLFxyXG4gICAgICAgIC8vJ2FwcC5ldmVudHMnXHJcbiAgICBdKTtcclxufSkoKTsiLCIvL2NvcmUubW9kdWxlLmpzXHJcbi8vbWFyay5sYXdyZW5jZVxyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIGFuZ3VsYXIubW9kdWxlKCdhcHAuY29yZScsXHJcbiAgICAgICAgW1xyXG4gICAgICAgICAgICAvL2FuZ3VsYXIgbW9kdWxlc1xyXG4gICAgICAgICAgICAnbmdNZXNzYWdlcycsXHJcbiAgICAgICAgICAgICdhbmd1bGFyTG9jYWxTdG9yYWdlJyxcclxuICAgICAgICAgICAgJ25nUm91dGUnLFxyXG4gICAgICAgICAgICAnbmdBbmltYXRlJyxcclxuXHJcbiAgICAgICAgICAgIC8vY3VzdG9tIG1vZHVsZXNcclxuICAgICAgICAgICAgJ2Jsb2Nrcy5sb2dnZXInLFxyXG4gICAgICAgICAgICAnYmxvY2tzLmV4Y2VwdGlvbicsXHJcblxyXG4gICAgICAgICAgICAvL3RoaXJkIHBhcnR5IG1vZHVsZXNcclxuICAgICAgICAgICAgJ3NtYXJ0LXRhYmxlJyxcclxuICAgICAgICAgICAgJ3VpLmJvb3RzdHJhcCcsXHJcbiAgICAgICAgICAgICduZ1RhZ3NJbnB1dCcsXHJcbiAgICAgICAgICAgICduZ0ZpbGVVcGxvYWQnLFxyXG4gICAgICAgICAgICAncnpNb2R1bGUnLFxyXG4gICAgICAgICAgICAnc3dpdGNoZXInLFxyXG4gICAgICAgICAgICAnZ2ZsLnRleHRBdmF0YXInLFxyXG4gICAgICAgICAgICAndGV4dEFuZ3VsYXInLFxyXG4gICAgICAgICAgICAndWkuYm9vdHN0cmFwLmRhdGV0aW1lcGlja2VyJywgXHJcbiAgICAgICAgICAgICdhbmd1bGFyLWNvbmZpcm0nIFxyXG4gICAgICAgIF0pXHJcbiAgICAgICAgLmNvbnN0YW50KCd0b2FzdHInLCB0b2FzdHIpXHJcbiAgICAgICAgLmNvbnN0YW50KCdtb21lbnQnLCBtb21lbnQpO1xyXG5cclxufSkoKTsiLCIvL2NvbmZpZy5qc1xyXG4vL21hcmsubGF3cmVuY2VcclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIHRvYXN0ckNvbmZpZyh0b2FzdHIpIHtcclxuICAgICAgICB0b2FzdHIub3B0aW9ucy50aW1lT3V0ID0gNDAwMDtcclxuICAgICAgICB0b2FzdHIub3B0aW9ucy5wb3NpdGlvbkNsYXNzID0gJ3RvYXN0LWJvdHRvbS1yaWdodCc7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBrZXlDb2RlcyA9IHtcclxuICAgICAgICBiYWNrc3BhY2U6IDgsXHJcbiAgICAgICAgdGFiOiA5LFxyXG4gICAgICAgIGVudGVyOiAxMyxcclxuICAgICAgICBlc2M6IDI3LFxyXG4gICAgICAgIHNwYWNlOiAzMixcclxuICAgICAgICBwYWdldXA6IDMzLFxyXG4gICAgICAgIHBhZ2Vkb3duOiAzNCxcclxuICAgICAgICBlbmQ6IDM1LFxyXG4gICAgICAgIGhvbWU6IDM2LFxyXG4gICAgICAgIGxlZnQ6IDM3LFxyXG4gICAgICAgIHVwOiAzOCxcclxuICAgICAgICByaWdodDogMzksXHJcbiAgICAgICAgZG93bjogNDAsXHJcbiAgICAgICAgaW5zZXJ0OiA0NSxcclxuICAgICAgICBkZWw6IDQ2XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBhcGlFbmRQb2ludHMgPSB7XHJcbiAgICAgICAgVXNlcjogJ3VzZXJzJyxcclxuICAgICAgICBDb25zdGl0dWVudDogJ2NvbnN0aXR1ZW50JyxcclxuICAgICAgICBUYXg6ICd0YXgnLFxyXG4gICAgICAgIFRlbXBsYXRlOiAndGVtcGxhdGUnLFxyXG4gICAgICAgIENhbXBhaWduOiAnY2FtcGFpZ24nLFxyXG4gICAgICAgIE1haWxlcjogJ21haWxlcicsXHJcbiAgICAgICAgUmVhc29uOiAncmVhc29uJyxcclxuICAgICAgICBFdmVudDogJ2V2ZW50JyxcclxuICAgICAgICBHdWVzdDogJ2d1ZXN0JyxcclxuICAgICAgICBGaWxlOiAnZmlsZSdcclxuICAgIH07XHJcblxyXG4gICAgdmFyIGNvbmZpZyA9IHtcclxuICAgICAgICBhcHBFcnJvclByZWZpeDogJ1tERyBFcnJvcl0gJywgLy9Db25maWd1cmUgdGhlIGV4Y2VwdGlvbkhhbmRsZXIgZGVjb3JhdG9yXHJcbiAgICAgICAgYXBwVGl0bGU6ICdEb25vckdhdGV3YXknLFxyXG4gICAgICAgIHZlcnNpb246ICcxLjAuMCcsXHJcbiAgICAgICAgYXBpVXJsOiAnaHR0cDovLycgKyB3aW5kb3cubG9jYXRpb24uaG9zdCArICcvYXBpLycsXHJcbiAgICAgICAga2V5Q29kZXM6IGtleUNvZGVzLFxyXG4gICAgICAgIGFwaUVuZFBvaW50czogYXBpRW5kUG9pbnRzXHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBkZWZhdWx0cyA9IHtcclxuICAgICAgICBFTUFJTF9TVUZGSVg6ICdAc3BsY2VudGVyLm9yZycsXHJcbiAgICAgICAgR0VORVJJQ19QQVNTV09SRDogJzFQQHNzd29yZCdcclxuICAgIH07XHJcblxyXG4gICAgYW5ndWxhci5tb2R1bGUoJ2FwcC5jb3JlJylcclxuICAgICAgICAuY29uZmlnKHRvYXN0ckNvbmZpZylcclxuICAgICAgICAuY29uc3RhbnQoJ2NvbmZpZycsIGNvbmZpZylcclxuICAgICAgICAudmFsdWUoJ2RlZmF1bHRzJywgZGVmYXVsdHMpO1xyXG59KSgpOyIsIi8vbWFyay5sYXdyZW5jZVxyXG4vL2V4Y2VwdGlvbi5tb2R1bGUuanNcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYmxvY2tzLmV4Y2VwdGlvbicsIFsnYmxvY2tzLmxvZ2dlciddKTtcclxufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xyXG4gICAgJ3VzZSBzdHJpY3QnO1xyXG5cclxuICAgIGFuZ3VsYXIubW9kdWxlKCdibG9ja3MubG9nZ2VyJywgW10pO1xyXG59KSgpOyIsIi8vZmlsdGVyLm1vZHVsZS5qc1xyXG4vL21hcmsubGF3cmVuY2VcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYXBwLmZpbHRlcicsIFtdKTtcclxufSkoKTsiLCIvL21hcmsubGF3cmVuY2VcclxuLy9uYXYubW9kdWxlLmpzXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgYW5ndWxhci5tb2R1bGUoJ2FwcC5uYXYnLCBbXSk7XHJcbn0pKCk7IiwiLy9zZXJ2aWNlLm1vZHVsZS5qc1xyXG4vL21hcmsubGF3cmVuY2VcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYXBwLnNlcnZpY2UnLCBbXSk7XHJcbn0pKCk7IiwiKGZ1bmN0aW9uICgpIHtcclxuICAgICd1c2Ugc3RyaWN0JztcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYXBwLnVzZXJzJywgW10pO1xyXG59KSgpOyIsIi8vbWFyay5sYXdyZW5jZVxyXG4vL2V4Y2VwdGlvbi1oYW5kbGVyLnByb3ZpZGVyLmpzXHJcblxyXG4vLyBJbmNsdWRlIGluIGluZGV4Lmh0bWwgc28gdGhhdCBhcHAgbGV2ZWwgZXhjZXB0aW9ucyBhcmUgaGFuZGxlZC5cclxuLy8gRXhjbHVkZSBmcm9tIHRlc3RSdW5uZXIuaHRtbCB3aGljaCBzaG91bGQgcnVuIGV4YWN0bHkgd2hhdCBpdCB3YW50cyB0byBydW5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgICd1c2Ugc3RyaWN0JztcclxuXHJcbiAgICBhbmd1bGFyXHJcbiAgICAgICAgLm1vZHVsZSgnYmxvY2tzLmV4Y2VwdGlvbicpXHJcbiAgICAgICAgLnByb3ZpZGVyKCdleGNlcHRpb25IYW5kbGVyJywgZXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyKVxyXG4gICAgICAgIC5jb25maWcoY29uZmlnKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIE11c3QgY29uZmlndXJlIHRoZSBleGNlcHRpb24gaGFuZGxpbmdcclxuICAgICAqIEByZXR1cm4ge1t0eXBlXX1cclxuICAgICAqL1xyXG4gICAgZnVuY3Rpb24gZXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyKCkge1xyXG4gICAgICAgIC8qIGpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xyXG4gICAgICAgIHRoaXMuY29uZmlnID0ge1xyXG4gICAgICAgICAgICBhcHBFcnJvclByZWZpeDogdW5kZWZpbmVkXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5jb25maWd1cmUgPSBmdW5jdGlvbiAoYXBwRXJyb3JQcmVmaXgpIHtcclxuICAgICAgICAgICAgdGhpcy5jb25maWcuYXBwRXJyb3JQcmVmaXggPSBhcHBFcnJvclByZWZpeDtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IGNvbmZpZzogdGhpcy5jb25maWcgfTtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIENvbmZpZ3VyZSBieSBzZXR0aW5nIGFuIG9wdGlvbmFsIHN0cmluZyB2YWx1ZSBmb3IgYXBwRXJyb3JQcmVmaXguXHJcbiAgICAgKiBBY2Nlc3NpYmxlIHZpYSBjb25maWcuYXBwRXJyb3JQcmVmaXggKHZpYSBjb25maWcgdmFsdWUpLlxyXG4gICAgICogQHBhcmFtICB7W3R5cGVdfSAkcHJvdmlkZVxyXG4gICAgICogQHJldHVybiB7W3R5cGVdfVxyXG4gICAgICogQG5nSW5qZWN0XHJcbiAgICAgKi9cclxuICAgIGZ1bmN0aW9uIGNvbmZpZygkcHJvdmlkZSkge1xyXG4gICAgICAgICRwcm92aWRlLmRlY29yYXRvcignJGV4Y2VwdGlvbkhhbmRsZXInLCBleHRlbmRFeGNlcHRpb25IYW5kbGVyKTtcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFeHRlbmQgdGhlICRleGNlcHRpb25IYW5kbGVyIHNlcnZpY2UgdG8gYWxzbyBkaXNwbGF5IGEgdG9hc3QuXHJcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9ICRkZWxlZ2F0ZVxyXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSBleGNlcHRpb25IYW5kbGVyXHJcbiAgICAgKiBAcGFyYW0gIHtPYmplY3R9IGxvZ2dlclxyXG4gICAgICogQHJldHVybiB7RnVuY3Rpb259IHRoZSBkZWNvcmF0ZWQgJGV4Y2VwdGlvbkhhbmRsZXIgc2VydmljZVxyXG4gICAgICovXHJcbiAgICBmdW5jdGlvbiBleHRlbmRFeGNlcHRpb25IYW5kbGVyKCRkZWxlZ2F0ZSwgZXhjZXB0aW9uSGFuZGxlciwgbG9nZ2VyKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChleGNlcHRpb24sIGNhdXNlKSB7XHJcbiAgICAgICAgICAgIHZhciBhcHBFcnJvclByZWZpeCA9IGV4Y2VwdGlvbkhhbmRsZXIuY29uZmlnLmFwcEVycm9yUHJlZml4IHx8ICcnO1xyXG4gICAgICAgICAgICB2YXIgZXJyb3JEYXRhID0geyBleGNlcHRpb246IGV4Y2VwdGlvbiwgY2F1c2U6IGNhdXNlIH07XHJcbiAgICAgICAgICAgIGV4Y2VwdGlvbi5tZXNzYWdlID0gYXBwRXJyb3JQcmVmaXggKyBleGNlcHRpb24ubWVzc2FnZTtcclxuICAgICAgICAgICAgJGRlbGVnYXRlKGV4Y2VwdGlvbiwgY2F1c2UpO1xyXG4gICAgICAgICAgICAvKipcclxuICAgICAgICAgICAgICogQ291bGQgYWRkIHRoZSBlcnJvciB0byBhIHNlcnZpY2UncyBjb2xsZWN0aW9uLFxyXG4gICAgICAgICAgICAgKiBhZGQgZXJyb3JzIHRvICRyb290U2NvcGUsIGxvZyBlcnJvcnMgdG8gcmVtb3RlIHdlYiBzZXJ2ZXIsXHJcbiAgICAgICAgICAgICAqIG9yIGxvZyBsb2NhbGx5LiBPciB0aHJvdyBoYXJkLiBJdCBpcyBlbnRpcmVseSB1cCB0byB5b3UuXHJcbiAgICAgICAgICAgICAqIHRocm93IGV4Y2VwdGlvbjtcclxuICAgICAgICAgICAgICpcclxuICAgICAgICAgICAgICogQGV4YW1wbGVcclxuICAgICAgICAgICAgICogICAgIHRocm93IHsgbWVzc2FnZTogJ2Vycm9yIG1lc3NhZ2Ugd2UgYWRkZWQnIH07XHJcbiAgICAgICAgICAgICAqL1xyXG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXhjZXB0aW9uLm1lc3NhZ2UsIGVycm9yRGF0YSk7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbn0pKCk7IiwiLy9tYXJrLmxhd3JlbmNlXHJcbi8vZXhjZXB0aW9uLmpzXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgJ3VzZSBzdHJpY3QnO1xyXG5cclxuICAgIGFuZ3VsYXJcclxuICAgICAgICAubW9kdWxlKCdibG9ja3MuZXhjZXB0aW9uJylcclxuICAgICAgICAuZmFjdG9yeSgnZXhjZXB0aW9uJywgZXhjZXB0aW9uKTtcclxuXHJcbiAgICAvKiBAbmdJbmplY3QgKi9cclxuICAgIGZ1bmN0aW9uIGV4Y2VwdGlvbihsb2dnZXIpIHtcclxuICAgICAgICB2YXIgc2VydmljZSA9IHtcclxuICAgICAgICAgICAgY2F0Y2hlcjogY2F0Y2hlclxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiBzZXJ2aWNlO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBjYXRjaGVyKG1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChyZWFzb24pIHtcclxuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihtZXNzYWdlLCByZWFzb24pO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH07XHJcbiAgICB9O1xyXG59KSgpOyIsIi8vbWFyay5sYXdyZW5jZVxyXG4vL2xvZ2dlci5qc1xyXG5cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgICd1c2Ugc3RyaWN0JztcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYmxvY2tzLmxvZ2dlcicpLmZhY3RvcnkoJ2xvZ2dlcicsIGxvZ2dlcik7XHJcblxyXG4gICAgbG9nZ2VyLiRpbmplY3QgPSBbJyRsb2cnLCAndG9hc3RyJ107XHJcblxyXG4gICAgZnVuY3Rpb24gbG9nZ2VyKCRsb2csIHRvYXN0cikge1xyXG4gICAgICAgIHZhciBzZXJ2aWNlID0ge1xyXG4gICAgICAgICAgICBzaG93VG9hc3RzOiB0cnVlLFxyXG5cclxuICAgICAgICAgICAgZXJyb3I6IGVycm9yLFxyXG4gICAgICAgICAgICBpbmZvOiBpbmZvLFxyXG4gICAgICAgICAgICBzdWNjZXNzOiBzdWNjZXNzLFxyXG4gICAgICAgICAgICB3YXJuaW5nOiB3YXJuaW5nLFxyXG5cclxuICAgICAgICAgICAgLy8gc3RyYWlnaHQgdG8gY29uc29sZTsgYnlwYXNzIHRvYXN0clxyXG4gICAgICAgICAgICBsb2c6ICRsb2cubG9nXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHNlcnZpY2U7XHJcbiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGVycm9yKG1lc3NhZ2UsIGRhdGEsIHRpdGxlKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci5lcnJvcihtZXNzYWdlLCB0aXRsZSk7XHJcbiAgICAgICAgICAgICRsb2cuZXJyb3IoJ0Vycm9yOiAnICsgbWVzc2FnZSwgZGF0YSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gaW5mbyhtZXNzYWdlLCBkYXRhLCB0aXRsZSkge1xyXG4gICAgICAgICAgICB0b2FzdHIuaW5mbyhtZXNzYWdlLCB0aXRsZSk7XHJcbiAgICAgICAgICAgICRsb2cuaW5mbygnSW5mbzogJyArIG1lc3NhZ2UsIGRhdGEpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHN1Y2Nlc3MobWVzc2FnZSwgZGF0YSwgdGl0bGUpIHtcclxuICAgICAgICAgICAgdG9hc3RyLnN1Y2Nlc3MobWVzc2FnZSwgdGl0bGUpO1xyXG4gICAgICAgICAgICAkbG9nLmluZm8oJ1N1Y2Nlc3M6ICcgKyBtZXNzYWdlLCBkYXRhKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBmdW5jdGlvbiB3YXJuaW5nKG1lc3NhZ2UsIGRhdGEsIHRpdGxlKSB7XHJcbiAgICAgICAgICAgIHRvYXN0ci53YXJuaW5nKG1lc3NhZ2UsIHRpdGxlKTtcclxuICAgICAgICAgICAgJGxvZy53YXJuKCdXYXJuaW5nOiAnICsgbWVzc2FnZSwgZGF0YSk7XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcbn0pKCk7IiwiLy9hcHAuZmlsdGVyLmpzXHJcbi8vbWFyay5sYXdyZW5jZVxyXG5cclxuYW5ndWxhci5tb2R1bGUoJ2FwcC5maWx0ZXInKS5maWx0ZXIoJ3BlcmNlbnRhZ2UnLCBbJyRmaWx0ZXInLCBmdW5jdGlvbiAoJGZpbHRlcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCwgZGVjaW1hbHMpIHtcclxuICAgICAgICByZXR1cm4gJGZpbHRlcignbnVtYmVyJykoaW5wdXQgKiAxMDAsIGRlY2ltYWxzKSArICclJztcclxuICAgIH07XHJcbn1dKTtcclxuXHJcbmFuZ3VsYXIubW9kdWxlKCdhcHAuZmlsdGVyJywgW10pLmZpbHRlcignY2hlY2ttYXJrJywgZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCkge1xyXG4gICAgICAgIHJldHVybiBpbnB1dCA/ICdcXHUyNzEzJyA6ICdcXHUyNzE4JztcclxuICAgIH07XHJcbn0pO1xyXG5cclxuYW5ndWxhci5tb2R1bGUoJ2FwcC5maWx0ZXInKS5maWx0ZXIoJ3llc05vJywgZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCkge1xyXG4gICAgICAgIHJldHVybiBpbnB1dCA/ICdZZXMnIDogJ05vJztcclxuICAgIH1cclxufSk7XHJcblxyXG5hbmd1bGFyLm1vZHVsZSgnYXBwLmZpbHRlcicpLmZpbHRlcigndXBkYXRlU3RhdHVzJywgZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChpbnB1dCkge1xyXG4gICAgICAgIGlmIChpbnB1dCA9PT0gMSkge1xyXG4gICAgICAgICAgICByZXR1cm4gJ1VuY2hhbmdlZCc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpbnB1dCA9PT0gMikge1xyXG4gICAgICAgICAgICByZXR1cm4gJ0NoYW5nZWQnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaW5wdXQgPT09IDYpIHtcclxuICAgICAgICAgICAgcmV0dXJuICdSZWNvbmNpbGVkJztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICB9O1xyXG59KTsiLCIvL21hcmsubGF3cmVuY2VcclxuLy9uYXYuanNcclxuXHJcbihmdW5jdGlvbiAoKSB7XHJcbiAgICAndXNlIHN0cmljdCc7XHJcblxyXG4gICAgdmFyIGNvbnRyb2xsZXJJZCA9ICdOYXZDb250cm9sbGVyJztcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYXBwLm5hdicpLmNvbnRyb2xsZXIoY29udHJvbGxlcklkLCBtYWluQ29udHJvbGxlcik7XHJcblxyXG4gICAgbWFpbkNvbnRyb2xsZXIuJGluamVjdCA9IFsnbG9nZ2VyJ107XHJcblxyXG4gICAgZnVuY3Rpb24gbWFpbkNvbnRyb2xsZXIobG9nZ2VyKSB7XHJcbiAgICAgICAgdmFyIHZtID0gdGhpcztcclxuXHJcbiAgICAgICAgYWN0aXZhdGUoKTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XHJcbiAgICAgICAgICAgIGxvZ2dlci5sb2coY29udHJvbGxlcklkICsgJyBhY3RpdmF0ZWQnKTtcclxuICAgICAgICAgICAgdm0udXNlciA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2N1cnJlbnRVc2VyJykpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn0pKCk7IiwiLy91c2VyLnNlcnZpY2UuanNcclxuLy9tYXJrLmxhd3JlbmNlXHJcblxyXG4oZnVuY3Rpb24gKCkge1xyXG4gICAgJ3VzZSBzdHJpY3QnO1xyXG5cclxuICAgIHZhciBzZXJ2aWNlSWQgPSAndXNlclNlcnZpY2UnO1xyXG4gICAgYW5ndWxhci5tb2R1bGUoJ2FwcC5zZXJ2aWNlJykuZmFjdG9yeShzZXJ2aWNlSWQsIHNlcnZpY2VDb250cm9sbGVyKTtcclxuXHJcbiAgICBmdW5jdGlvbiBzZXJ2aWNlQ29udHJvbGxlcihsb2dnZXIsICRodHRwLCBjb25maWcpIHtcclxuICAgICAgICBsb2dnZXIubG9nKHNlcnZpY2VJZCArICcgbG9hZGVkJyk7XHJcbiAgICAgICAgdmFyIHVybCA9IGNvbmZpZy5hcGlVcmwgKyBjb25maWcuYXBpRW5kUG9pbnRzLlVzZXI7XHJcblxyXG4gICAgICAgIHZhciBzZXJ2aWNlID0ge1xyXG4gICAgICAgICAgICBhdmFpbGFibGVSb2xlczogYXZhaWxhYmxlUm9sZXMsXHJcbiAgICAgICAgICAgIGNyZWF0ZTogY3JlYXRlLFxyXG4gICAgICAgICAgICBnZXQ6IGdldCxcclxuICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LFxyXG4gICAgICAgICAgICByZW1vdmU6IHJlbW92ZSxcclxuICAgICAgICAgICAgdXBkYXRlOiB1cGRhdGVcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzZXJ2aWNlO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBhdmFpbGFibGVSb2xlcygpIHtcclxuICAgICAgICAgICAgcmV0dXJuICRodHRwLmdldCh1cmwgKyAnL3JvbGVzJykudGhlbihfc3VjY2Vzcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBjcmVhdGUodXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAucG9zdCh1cmwsIHVzZXIpLnRoZW4oX3N1Y2Nlc3MsIGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmxvZygnZXJyb3InLCBlcnJvcik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZ2V0KCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCkudGhlbihfc3VjY2Vzcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBxdWVyeShzZWFyY2hUZXJtKSB7XHJcbiAgICAgICAgICAgIHZhciBzZWFyY2hVcmwgPSB1cmwgKyAnL3NlYXJjaC8nO1xyXG5cclxuICAgICAgICAgICAgaWYgKHNlYXJjaFRlcm0gIT0gdW5kZWZpbmVkICYmIHNlYXJjaFRlcm0ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoVXJsICs9ICc/JyArIHNlYXJjaFRlcm07XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQoc2VhcmNoVXJsKS50aGVuKF9zdWNjZXNzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHVwZGF0ZSh1c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAkaHR0cC5wdXQodXJsLCB1c2VyKS50aGVuKF9zdWNjZXNzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHJlbW92ZShpZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJGh0dHAuZGVsZXRlKHVybCArICcvJyArIGlkKS50aGVuKF9zdWNjZXNzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIF9zdWNjZXNzKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xyXG4gICAgJ3VzZSBzdHJpY3QnOyBcclxuXHJcbiAgICB2YXIgY29udHJvbGxlcklkID0gJ1VzZXJDb250cm9sbGVyJztcclxuXHJcbiAgICBhbmd1bGFyLm1vZHVsZSgnYXBwLnVzZXJzJykuY29udHJvbGxlcihjb250cm9sbGVySWQsIFVzZXJDb250cm9sbGVyKTtcclxuXHJcbiAgICBVc2VyQ29udHJvbGxlci4kaW5qZWN0ID0gWydsb2dnZXInLCAndXNlclNlcnZpY2UnLCAnZGVmYXVsdHMnLCAnY29uZmlnJ107XHJcblxyXG4gICAgZnVuY3Rpb24gVXNlckNvbnRyb2xsZXIobG9nZ2VyLCBzZXJ2aWNlLCBkZWZhdWx0cywgY29uZmlnKSB7XHJcbiAgICAgICAgdmFyIHZtID0gdGhpcztcclxuICAgICAgICB2bS50aXRsZSA9ICdVc2VyIE1hbmFnZXInO1xyXG4gICAgICAgIHZtLmRlc2NyaXB0aW9uID0gJ0VkaXQgYW5kIHVwZGF0ZSB1c2Vycyc7XHJcbiAgICAgICAgdmFyIGtleUNvZGVzID0gY29uZmlnLmtleUNvZGVzO1xyXG5cclxuICAgICAgICB2bS5hdmFpbGFibGVSb2xlcyA9IFtdO1xyXG4gICAgICAgIHZtLmNsZWFyQ3JlYXRlID0gY2xlYXJDcmVhdGU7XHJcbiAgICAgICAgdm0uY3VycmVudEVkaXQgPSB7fTtcclxuICAgICAgICB2bS5pc0J1c3kgPSBmYWxzZTtcclxuICAgICAgICB2bS5sYXN0RGVsZXRlZCA9IG51bGw7XHJcbiAgICAgICAgdm0ubGFzdFVwZGF0ZWQgPSBudWxsO1xyXG4gICAgICAgIHZtLml0ZW1Ub0VkaXQgPSB7fTtcclxuXHJcbiAgICAgICAgdm0udXNlciA9IHtcclxuICAgICAgICAgICAgLy91c2VyTmFtZTogbnVsbCxcclxuICAgICAgICAgICAgcm9sZXM6IFsndXNlciddLFxyXG4gICAgICAgICAgICBmdWxsTmFtZTogJycsXHJcbiAgICAgICAgICAgIHBhc3N3b3JkOiBkZWZhdWx0cy5HRU5FUklDX1BBU1NXT1JEXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHRhYmxlU3RhdGVSZWY7XHJcblxyXG4gICAgICAgIGFjdGl2YXRlKCk7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIGFjdGl2YXRlKCkge1xyXG4gICAgICAgICAgICBsb2dnZXIubG9nKGNvbnRyb2xsZXJJZCArICcgYWN0aXZhdGVkJyk7XHJcbiAgICAgICAgICAgIGdldEF2YWlsYWJsZVJvbGVzKCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdm0uYWRkSXRlbSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdm0udXNlci5mdWxsTmFtZSA9IHBhcnNlRnVsbE5hbWUodm0udXNlci51c2VyTmFtZSk7XHJcbiAgICAgICAgICAgIHZtLnVzZXIuZW1haWwgPSB2bS51c2VyLnVzZXJOYW1lICsgZGVmYXVsdHMuRU1BSUxfU1VGRklYO1xyXG4gICAgICAgICAgICBzZXJ2aWNlLmNyZWF0ZSh2bS51c2VyKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL1RPRE86IG1hcHBpbmcgd291bGQgYWxsb3cgcmVtb3ZhbCBvZiBleHRlbmQgbWV0aG9kXHJcbiAgICAgICAgICAgICAgICAgICAgdm0udXNlciA9IGFuZ3VsYXIuZXh0ZW5kKHZtLnVzZXIsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZtLnVzZXJzLnVuc2hpZnQoYW5ndWxhci5jb3B5KHZtLnVzZXIpKTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuc3VjY2VzcygnVXNlciAnICsgdm0udXNlci51c2VyTmFtZSArICcgY3JlYXRlZCEnKTtcclxuICAgICAgICAgICAgICAgICAgICB2bS51c2VyLnVzZXJOYW1lID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAvL1RPRE86IHNob3cgZXJyb3IgdXNlciBhbHJlYWR5IGV4aXN0c1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdm0uY2FuY2VsRWRpdCA9IGZ1bmN0aW9uIChpZCkge1xyXG4gICAgICAgICAgICB2bS5jdXJyZW50RWRpdFtpZF0gPSBmYWxzZTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2bS5kZWxldGVJdGVtID0gZnVuY3Rpb24gKHVzZXIpIHtcclxuICAgICAgICAgICAgYW5ndWxhci5jb3B5KHVzZXIsIHZtLmxhc3REZWxldGVkID0ge30pO1xyXG4gICAgICAgICAgICBzZXJ2aWNlLnJlbW92ZSh1c2VyLmlkKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gdm0udXNlcnMuaW5kZXhPZih1c2VyKTtcclxuICAgICAgICAgICAgICAgICAgICB2bS51c2Vycy5zcGxpY2UoaWR4LCAxKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZtLmVkaXRJdGVtID0gZnVuY3Rpb24gKHVzZXIpIHtcclxuICAgICAgICAgICAgdm0uY3VycmVudEVkaXRbdXNlci5pZF0gPSB0cnVlO1xyXG4gICAgICAgICAgICBhbmd1bGFyLmNvcHkodXNlciwgdm0uaXRlbVRvRWRpdCA9IHt9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBnZXRBdmFpbGFibGVSb2xlcygpIHtcclxuICAgICAgICAgICAgc2VydmljZS5hdmFpbGFibGVSb2xlcygpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZtLmF2YWlsYWJsZVJvbGVzID0gZGF0YTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZtLnNhdmVJdGVtID0gZnVuY3Rpb24gKHVzZXIpIHtcclxuICAgICAgICAgICAgdm0uaXNCdXN5ID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHZtLmN1cnJlbnRFZGl0W3VzZXIuaWRdID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGFuZ3VsYXIuY29weSh1c2VyLCB2bS5sYXN0VXBkYXRlZCA9IHt9KTtcclxuICAgICAgICAgICAgdmFyIHJvbGVzID0gW107XHJcblxyXG4gICAgICAgICAgICBfLmZvckVhY2godm0uaXRlbVRvRWRpdC5yb2xlcyxcclxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyb2xlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcm9sZXMucHVzaChyb2xlLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHZtLml0ZW1Ub0VkaXQucm9sZXMgPSByb2xlcztcclxuXHJcbiAgICAgICAgICAgIHNlcnZpY2UudXBkYXRlKHZtLml0ZW1Ub0VkaXQpXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHVzZXIsIGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxvZ2dlci5zdWNjZXNzKCdVc2VyICcgKyBkYXRhLnVzZXJOYW1lICsgJyB1cGRhdGVkIScpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZtLmlzQnVzeSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdm0uc2VhcmNoID0gZnVuY3Rpb24gKHRhYmxlU3RhdGUpIHtcclxuICAgICAgICAgICAgdGFibGVTdGF0ZVJlZiA9IHRhYmxlU3RhdGU7XHJcbiAgICAgICAgICAgIHZhciBzZWFyY2hUZXJtO1xyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiAodGFibGVTdGF0ZS5zZWFyY2gucHJlZGljYXRlT2JqZWN0KSAhPSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoVGVybSA9IHRhYmxlU3RhdGUuc2VhcmNoLnByZWRpY2F0ZU9iamVjdC5zZWFyY2hUZXJtO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2bS5pc0J1c3kgPSB0cnVlO1xyXG4gICAgICAgICAgICBzZXJ2aWNlLnF1ZXJ5KHNlYXJjaFRlcm0pXHJcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZtLnVzZXJzID0gZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dnZXIubG9nKCd1c2VycycsIHZtLnVzZXJzKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuZmluYWxseShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdm0uaXNCdXN5ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2bS51bmRvRGVsZXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgcm9sZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgIF8uZm9yRWFjaCh2bS5sYXN0RGVsZXRlZC5yb2xlcywgZnVuY3Rpb24gKHJvbGUpIHtcclxuICAgICAgICAgICAgICAgIHJvbGVzLnB1c2gocm9sZS5uYW1lKTtcclxuICAgICAgICAgICAgICAgIGxvZ2dlci5sb2coJ3JvbGUnLCByb2xlLm5hbWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdm0ubGFzdERlbGV0ZWQucm9sZXMgPSByb2xlcztcclxuICAgICAgICAgICAgdm0ubGFzdERlbGV0ZWQucGFzc3dvcmQgPSBkZWZhdWx0cy5HRU5FUklDX1BBU1NXT1JEO1xyXG5cclxuICAgICAgICAgICAgc2VydmljZS5jcmVhdGUodm0ubGFzdERlbGV0ZWQpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGxvZ2dlci5zdWNjZXNzKCdTdWNjZXNzZnVsbHkgcmVzdG9yZWQgJyArIGRhdGEudXNlck5hbWUpO1xyXG4gICAgICAgICAgICAgICAgdm0udXNlcnMudW5zaGlmdChkYXRhKTtcclxuICAgICAgICAgICAgICAgIHZtLmxhc3REZWxldGVkID0gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdm0udW5kb0NoYW5nZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdm0uaXNCdXN5ID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHNlcnZpY2UudXBkYXRlKHZtLmxhc3RVcGRhdGVkKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2godm0udXNlcnMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICh1LCBpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodS5pZCA9PT0gdm0ubGFzdFVwZGF0ZWQuaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bS51c2Vyc1tpXSA9IHZtLmxhc3RVcGRhdGVkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuc3VjY2VzcygnU3VjY2Vzc2Z1bGx5IHJlc3RvcmVkICcgKyBkYXRhLnVzZXJOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICB2bS5sYXN0VXBkYXRlZCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmZpbmFsbHkoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZtLmlzQnVzeSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gY2xlYXJDcmVhdGUoJGV2ZW50KSB7XHJcbiAgICAgICAgICAgIGlmICgkZXZlbnQua2V5Q29kZSA9PT0ga2V5Q29kZXMuZXNjKSB7XHJcbiAgICAgICAgICAgICAgICB2bS51c2VyLnVzZXJOYW1lID0gJyc7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gcGFyc2VGdWxsTmFtZShuYW1lKSB7XHJcbiAgICAgICAgICAgIHZhciBhcnIgPSBuYW1lLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIHZhciBmdWxsbmFtZSA9ICcnO1xyXG5cclxuICAgICAgICAgICAgXy5mb3JFYWNoKGFyciwgZnVuY3Rpb24gKHYpIHtcclxuICAgICAgICAgICAgICAgIGZ1bGxuYW1lICs9IF8uY2FwaXRhbGl6ZSh2KSArICcgJztcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gXy50cmltKGZ1bGxuYW1lKTtcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxufSkoKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
